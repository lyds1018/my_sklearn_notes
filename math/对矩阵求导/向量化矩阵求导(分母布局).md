
## 1. vec 定义

设矩阵 $A \in \mathbb{R}^{m \times n}$，则有

$$
\ A
= \begin{bmatrix}
a_{11} & a_{12} & \cdots & a_{1n} \\
a_{21} & a_{22} & \cdots & a_{2n} \\
\vdots & \vdots & \ddots & \vdots \\
a_{m1} & a_{m2} & \cdots & a_{mn}
\end{bmatrix} \in \mathbb{R}^{m \times n}, \
\mathrm{vec}(A) 
= \begin{bmatrix}
a_{11} \\ a_{21} \\ \vdots \\ a_{m1}
\\ \vdots \\ a_{1n} \\ \vdots \\ a_{mn}
\end{bmatrix} \in \mathbb{R}^{mn}
$$
- 即向量 $\mathrm{vec}(A)$ 由矩阵 $A$ 的所有列堆成

## 2. vec 两个恒等式

$$
\mathrm{vec}(AXB) = (B^\top \otimes A) \ \mathrm{vec}(X)
$$
$$
\mathrm{vec}(dY) = (\frac{\partial \mathrm{vec}(Y)}{\partial \mathrm{vec}(X)})^\top \mathrm{vec}(dX)
$$
-  $dY = d(AXB) = AdXB$
- A, B既可以是矩阵，也可以是向量，只要维度匹配即可

## 3. vec 链式法则

设 $L = Y(X)$，则有

$$
\mathrm{vec}\!\left(\frac{\partial L}{\partial X}\right)
= \frac{\partial \, \mathrm{vec}(Y)}{\partial \, \mathrm{vec}(X)}\
\mathrm{vec}\!\left(\frac{\partial L}{\partial Y}\right)
$$

## 4. kronecker 性质 

$$
(A \otimes B)^\top = (A^\top \otimes B^\top)
$$
## 5. 向量化求导步骤

设 $L = Y(X) = MXN$

### (1) 写出 dY
$$
dY = MdXN
$$

### (2) vec 拆解 dY
$$
\mathrm{vec}(dY) = (N^\top \otimes M) \ \mathrm{vec}(dX)
$$

### (3) 提取 vec 梯度

$$
\frac{\partial \, \mathrm{vec}(Y)}{\partial \, \mathrm{vec}(X)}
= (N^\top \otimes M)^\top
= (N \otimes M^\top)
$$
### (4) 代入 vec 链式法则
$$
\begin{align}
\mathrm{vec}\!\left(\frac{\partial L}{\partial X}\right)
&= \frac{\partial \, \mathrm{vec}(Y)}{\partial \, \mathrm{vec}(X)}\
\mathrm{vec}\!\left(\frac{\partial L}{\partial Y}\right) \\
&= (N \otimes M^\top)\ \mathrm{vec}\!\left(\frac{\partial L}{\partial Y}\right)
\end{align}
$$
### (5) 由 $\mathrm{vec}(AXB) = (B^\top \otimes A) \ \mathrm{vec}(X)$ 提取梯度
$$
\frac{\partial L}{\partial X}
= M^\top \ \frac{\partial L}{\partial Y} \ N^\top
$$