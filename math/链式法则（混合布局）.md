
假设有多层向量函数和标量损失：

$$
\mathbf{x}^{(0)} \xrightarrow{\mathbf{f_0}} \mathbf{x}^{(1)} \xrightarrow{\mathbf{f_1}} \cdots \xrightarrow{\mathbf{f_{L-1}}} \mathbf{x}^{(L)} \xrightarrow{f_L}L
$$

## 1. 布局定义

| 符号                                                                              | 含义         | 布局   |
| ------------------------------------------------------------------------------- | ---------- | ---- |
| $$\mathbf{x}^{(k)}$$                                                            | 第 k 层向量    | 列向量  |
| $$J^{(k)} = \frac{\partial \mathbf{x}^{(k)}}{\partial \mathbf{x}^{(k-1)\top}}$$ | 第 k 层雅可比矩阵 | 分子布局 |
| $$\nabla_{\mathbf{x}^{(k)}} L = \frac{\partial L}{\partial \mathbf{x}^{(k)}}$$  | 损失对第 k 层梯度 | 分母布局 |

## 2️. 链式法则（反向传播）

递推公式：
$$
\nabla_{\mathbf{x}^{(k-1)}} L = \left( J^{(k)} \right)^\top \nabla_{\mathbf{x}^{(k)}} L
= \left( \frac{\partial \mathbf{x}^{(k)}}{\partial \mathbf{x}^{(k-1)\top}} \right)^\top \nabla_{\mathbf{x}^{(k)}} L
$$
递推结果：
$$
\nabla_{\mathbf{x}^{(0)}} L
= (J^{(0)})^\top (J^{(1)})^\top \cdots (J^{(L-1)})^\top \, \nabla_{\mathbf{x}^{(L)}} L
= \left[ \prod_{k=1}^{L} \left( \frac{\partial \mathbf{x}^{(k)}}{\partial \mathbf{x}^{(k-1)\top}} \right)^\top \right] 
  \frac{\partial L}{\partial \mathbf{x}^{(L)}}
$$

